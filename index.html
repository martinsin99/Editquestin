<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Preguntas Moodle</title>
    <!-- 1. Se incluye Tailwind CSS directamente para que los estilos funcionen sin instalación -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos adicionales para mejorar la apariencia y el scroll */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        .cell-textarea {
            min-height: 75px; /* Altura mínima para las celdas de texto */
        }
        .selected-row {
            background-color: #EBF8FF; /* Un azul claro para las filas seleccionadas */
        }
        /* Animación para el mensaje de guardado */
        .fade-out {
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .keyword-tab-btn.active {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .keyword-tab-btn:not(.active) {
            background-color: #E5E7EB; /* gray-200 */
            color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">

    <!-- Encabezado y Barra de Herramientas -->
    <header class="bg-white shadow-md p-4 z-20">
        <div class="max-w-screen-2xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-center sm:text-left">
                <div id="title-container">
                    <h1 id="app-title" class="text-2xl font-bold text-gray-800 cursor-pointer hover:bg-gray-100 p-1 rounded-md transition-colors">Editor de Preguntas Moodle</h1>
                </div>
                <p class="text-sm text-gray-500">Virtualizado para Máximo Rendimiento</p>
            </div>
             <div class="relative w-full sm:w-auto max-w-xs">
                <input type="text" id="search-input" placeholder="Buscar en preguntas..." class="w-full p-2 pl-10 border rounded-lg text-sm focus:ring-2 focus:ring-blue-400">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div class="flex items-center justify-center flex-wrap gap-2">
                <button id="toggle-view-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="Cambiar Vista">
                    <svg id="table-view-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18M3 6h18M3 18h18"></path></svg>
                    <svg id="text-view-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                </button>
                <button id="toggle-filters-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="Mostrar/Ocultar Filtros">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L16 11.414V16a1 1 0 01-.293.707l-2 2A1 1 0 0113 18v-1.586l-1.707-1.707A1 1 0 0111 14V11.414L3.293 6.707A1 1 0 013 6V4z"></path></svg>
                </button>
                <button id="undo-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Deshacer (Ctrl+Z)" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8A5 5 0 009 9V5"></path></svg>
                </button>
                <button id="redo-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Rehacer (Ctrl+Y)" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 15l3-3m0 0l-3-3m3 3H5a5 5 0 005 5v-2a3 3 0 013-3z"></path></svg>
                </button>
                <div class="relative">
                    <button id="save-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="Guardar Progreso">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3l-4-4-4 4z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    <span id="save-feedback" class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs bg-green-500 text-white px-2 py-1 rounded-md opacity-0">Guardado</span>
                </div>
                <button id="settings-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="Edición Masiva">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <input type="file" id="xml-file-input" class="hidden" accept=".xml"/>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv"/>
                <button id="import-paste-btn" class="flex items-center px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600">Pegar CSV</button>
                <button id="import-xml-btn" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Importar XML</button>
                <button id="import-csv-btn" class="flex items-center px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700">Importar CSV</button>
                <button id="autoclassify-btn" class="flex items-center px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 disabled:bg-gray-400">Auto-clasificar</button>
                <button id="edit-keywords-btn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors" title="Editar Pistas de Clasificación">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-5.747-8.56l11.494 5.747m-5.747-11.494L6.253 18m11.494-11.494L6.253 6.253"></path></svg>
                </button>
                <button id="export-btn" class="flex items-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400" disabled>Exportar</button>
                <button id="clear-all-btn" class="p-2 rounded-lg hover:bg-red-100 text-red-600 transition-colors" title="Borrar Todo">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>
        <div id="settings-bar" class="transition-all duration-300 ease-in-out overflow-hidden max-h-0">
            <div class="bg-gray-50 p-4 rounded-lg border mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                <h3 class="font-semibold text-gray-700 col-span-full">Edición Masiva:</h3>
                <div><label class="block text-xs font-medium text-gray-600">Año</label><input type="text" id="global-year" placeholder="Ej: 2025" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Tipo de Examen</label><input type="text" id="global-exam" placeholder="Ej: Parcial 1" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Categoría/Materia</label><input type="text" id="global-category" placeholder="Ej: Medicina" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Tema</label><input type="text" id="global-topic" placeholder="Ej: Cardiología" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Carrera</label><input type="text" id="global-career" placeholder="Medicina" class="p-2 border rounded-md text-sm w-full"/></div>
                <button id="apply-massive-edit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 w-full sm:col-span-2 lg:col-span-1">Aplicar a Todo</button>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="flex-grow p-2 sm:p-4 lg:p-6 flex flex-col overflow-hidden">
        <div id="error-container" class="hidden max-w-screen-2xl mx-auto bg-red-100 border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
        <div id="table-view" class="flex-grow flex flex-col bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <!-- Encabezado de la Tabla y Filtros -->
            <div id="table-header" class="overflow-x-auto hide-scrollbar border-b border-gray-200"></div>
            <!-- Cuerpo de la Tabla (Virtualizado) -->
            <div id="table-body-container" class="flex-grow w-full h-full overflow-auto">
                <div id="table-body-sizer" class="relative">
                    <div id="table-body" class="absolute top-0 left-0 w-full"></div>
                </div>
            </div>
        </div>
        <div id="text-view" class="hidden flex-grow flex flex-col bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <textarea id="text-view-area" class="w-full h-full p-4 font-mono text-sm border-0 focus:ring-0 resize-none"></textarea>
        </div>
    </main>

    <!-- Barra de Herramientas Avanzada (oculta por defecto) -->
    <div id="advanced-toolbar" class="hidden bg-gray-800 text-white p-3 shadow-lg transition-transform duration-300 ease-in-out">
        <div class="max-w-screen-2xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-3">
            <span id="selection-count">0 filas seleccionadas</span>
            <div class="flex items-center space-x-4">
                <button id="batch-edit-btn" class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg">Modificar Selección</button>
                <button id="batch-delete-btn" class="flex items-center px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg">Eliminar Selección</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edición -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center"><h2 id="modal-title" class="text-xl font-bold text-gray-800">Editar Pregunta</h2></header>
            <main id="modal-content" class="p-6 overflow-y-auto"></main>
            <footer class="p-4 border-t flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50 rounded-b-xl">
                <div class="flex items-center gap-2">
                    <button id="modal-delete-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">
                        <svg class="w-5 h-5 inline-block -mt-1 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Eliminar Pregunta
                    </button>
                    <button id="modal-autoclassify-btn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700">Auto-clasificar Categoría</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="modal-prev" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                    <button id="modal-next" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">Siguiente</button>
                </div>
                <div>
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cerrar</button>
                    <button id="modal-save" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar y Cerrar</button>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Modal para Pegar CSV -->
    <div id="paste-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col">
            <header class="p-4 border-b"><h2 class="text-xl font-bold text-gray-800">Pegar Contenido CSV</h2></header>
            <main class="p-6">
                <p class="text-sm text-gray-600 mb-2">Pega aquí las filas de tu CSV. Asegúrate de que el formato y las columnas coincidan con la exportación.</p>
                <textarea id="paste-csv-area" class="w-full h-64 p-2 border rounded-md font-mono text-sm" placeholder="text,option_a,option_b,...,career"></textarea>
            </main>
            <footer class="p-4 border-t flex justify-end space-x-3 bg-gray-50 rounded-b-xl">
                <button id="paste-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="paste-process-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Procesar y Añadir</button>
            </footer>
        </div>
    </div>

    <!-- Modal para Edición en Conjunto -->
    <div id="batch-edit-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col">
            <header class="p-4 border-b"><h2 class="text-xl font-bold text-gray-800">Modificar Selección</h2></header>
            <main class="p-6 space-y-4">
                <p class="text-sm text-gray-600">Introduce los valores que quieres aplicar a todas las filas seleccionadas. Deja un campo en blanco para no modificarlo.</p>
                <div><label class="block text-xs font-medium text-gray-600">Año</label><input type="text" id="batch-year" placeholder="Ej: 2025" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Tipo de Examen</label><input type="text" id="batch-exam" placeholder="Ej: Parcial 1" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Categoría/Materia</label><input type="text" id="batch-category" placeholder="Ej: Medicina" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Tema</label><input type="text" id="batch-topic" placeholder="Ej: Cardiología" class="p-2 border rounded-md text-sm w-full"/></div>
                <div><label class="block text-xs font-medium text-gray-600">Carrera</label><input type="text" id="batch-career-modal" placeholder="Medicina" class="p-2 border rounded-md text-sm w-full"/></div>
            </main>
            <footer class="p-4 border-t flex justify-end space-x-3 bg-gray-50 rounded-b-xl">
                <button id="batch-edit-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="batch-edit-apply-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Aplicar Cambios</button>
            </footer>
        </div>
    </div>

    <!-- Menú emergente para Clasificación Rápida -->
    <div id="classify-popup" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[60] flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-xl flex flex-col w-full max-w-md max-h-[80vh]">
            <input type="text" id="classify-search" class="p-3 border-b focus:outline-none text-lg" placeholder="Buscar categoría...">
            <div id="classify-list" class="p-2 overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Modal para Editar Pistas de Auto-clasificación -->
    <div id="keywords-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Editar Pistas de Auto-clasificación</h2>
            </header>
            <nav class="p-2 border-b">
                <div id="keywords-tabs" class="flex space-x-2">
                    <button data-career="Medicina" class="keyword-tab-btn px-4 py-2 rounded-md font-semibold">Medicina</button>
                    <button data-career="Enfermeria" class="keyword-tab-btn px-4 py-2 rounded-md font-semibold">Enfermería</button>
                </div>
            </nav>
            <main id="keywords-content" class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Content will be generated by JS -->
            </main>
            <footer class="p-4 border-t flex justify-between items-center bg-gray-50 rounded-b-xl">
                <button id="keywords-restore-btn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Restaurar por Defecto</button>
                <div>
                    <button id="keywords-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button id="keywords-save-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                </div>
            </footer>
        </div>
    </div>


    <!-- 2. Toda la lógica de la aplicación está en este script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            let questions = [];
            let filteredIndices = [];
            let fileName = 'exportacion_moodle';
            let editingQuestionIndex = null;
            let debounceTimers = {};
            let selectedRows = new Set();
            let history = [];
            let historyIndex = -1;
            let currentView = 'table'; // 'table' or 'text'
            let filters = {};
            let searchTerm = '';
            let showFilters = false;
            let lastCheckedIndex = null;

            // --- DOM Elements ---
            const importXmlBtn = document.getElementById('import-xml-btn');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const importPasteBtn = document.getElementById('import-paste-btn');
            const exportBtn = document.getElementById('export-btn');
            const xmlFileInput = document.getElementById('xml-file-input');
            const csvFileInput = document.getElementById('csv-file-input');
            const errorContainer = document.getElementById('error-container');
            const tableHeader = document.getElementById('table-header');
            const tableBodyContainer = document.getElementById('table-body-container');
            const tableBodySizer = document.getElementById('table-body-sizer');
            const tableBody = document.getElementById('table-body');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsBar = document.getElementById('settings-bar');
            const saveBtn = document.getElementById('save-btn');
            const saveFeedback = document.getElementById('save-feedback');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const tableViewIcon = document.getElementById('table-view-icon');
            const textViewIcon = document.getElementById('text-view-icon');
            const tableView = document.getElementById('table-view');
            const textView = document.getElementById('text-view');
            const textViewArea = document.getElementById('text-view-area');
            const autoclassifyBtn = document.getElementById('autoclassify-btn');
            const titleContainer = document.getElementById('title-container');
            const appTitle = document.getElementById('app-title');
            const globalYearInput = document.getElementById('global-year');
            const globalExamInput = document.getElementById('global-exam');
            const globalCategoryInput = document.getElementById('global-category');
            const globalTopicInput = document.getElementById('global-topic');
            const globalCareerInput = document.getElementById('global-career');
            const applyMassiveEditBtn = document.getElementById('apply-massive-edit');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalSaveBtn = document.getElementById('modal-save');
            const modalCancelBtn = document.getElementById('modal-cancel');
            const modalPrevBtn = document.getElementById('modal-prev');
            const modalNextBtn = document.getElementById('modal-next');
            const modalAutoclassifyBtn = document.getElementById('modal-autoclassify-btn');
            const modalDeleteBtn = document.getElementById('modal-delete-btn');
            const classifyPopup = document.getElementById('classify-popup');
            const classifySearch = document.getElementById('classify-search');
            const classifyList = document.getElementById('classify-list');
            const pasteModalContainer = document.getElementById('paste-modal-container');
            const pasteCsvArea = document.getElementById('paste-csv-area');
            const pasteProcessBtn = document.getElementById('paste-process-btn');
            const pasteCancelBtn = document.getElementById('paste-cancel-btn');
            const advancedToolbar = document.getElementById('advanced-toolbar');
            const selectionCount = document.getElementById('selection-count');
            const batchEditBtn = document.getElementById('batch-edit-btn');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const batchEditModalContainer = document.getElementById('batch-edit-modal-container');
            const batchEditCancelBtn = document.getElementById('batch-edit-cancel-btn');
            const batchEditApplyBtn = document.getElementById('batch-edit-apply-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const editKeywordsBtn = document.getElementById('edit-keywords-btn');
            const keywordsModalContainer = document.getElementById('keywords-modal-container');
            const keywordsTabs = document.getElementById('keywords-tabs');
            const keywordsContent = document.getElementById('keywords-content');
            const keywordsSaveBtn = document.getElementById('keywords-save-btn');
            const keywordsCancelBtn = document.getElementById('keywords-cancel-btn');
            const keywordsRestoreBtn = document.getElementById('keywords-restore-btn');
            const searchInput = document.getElementById('search-input');
            const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
            
            // --- Table & Virtualization Config ---
            const TABLE_HEADERS = [
                { key: 'select', label: '<input type="checkbox" id="select-all-checkbox">', width: 40 },
                { key: 'rowNum', label: '#', width: 50 },
                { key: 'actions', label: 'Acciones', width: 80 }, { key: 'text', label: 'Texto de la Pregunta', width: 350 },
                { key: 'option_a', label: 'Opción A', width: 200 }, { key: 'option_b', label: 'Opción B', width: 200 },
                { key: 'option_c', label: 'Opción C', width: 200 }, { key: 'option_d', label: 'Opción D', width: 200 },
                { key: 'correctAnswerId', label: 'Resp. Correcta', width: 120 }, { key: 'category', label: 'Categoría', width: 150 },
                { key: 'year', label: 'Año', width: 100 }, { key: 'examType', label: 'Tipo Examen', width: 150 },
                { key: 'topic', label: 'Tema', width: 150 }, { key: 'justification', label: 'Justificación', width: 400 },
                { key: 'career', label: 'Carrera', width: 150 }
            ];
            const ROW_HEIGHT = 95;
            const OVERSCAN_COUNT = 5;
            const totalWidth = TABLE_HEADERS.reduce((acc, h) => acc + h.width, 0);
            
            const MEDICINE_CATEGORIES = ["Cardiología", "Dermatología", "Gastroenterología", "Endocrinología", "Hematología", "Infectología", "Nefrología", "Neurología", "Neumología", "Reumatología", "Neonatologia", "Pediatria", "Ginecologia", "Obstetricia", "Cirugia general", "Oftalmologia", "Otorrinolaringología", "Traumatologia", "Urologia", "Psiquiatría", "Salud Pública / Epidemiología", "Bióetica"];
            const NURSING_CATEGORIES = ["Generalidades para el cuidado enfermero", "Procedimientos básicos del cuidado enfermero", "Proceso de atención en Enfermería", "Bioseguridad", "Ética en el ejercicio profesional", "Seguridad y calidad en el cuidado", "Salud sexual y reproductiva", "Salud sexual y reproductiva de la mujer", "Cuidados de enfermería en el embarazo, parto y puerperio", "Cuidados gineco-obstétricos de la mujer", "Cuidados de enfermería en el recién nacido", "Generalidades sobre niñez y adolescencia", "Cuidados de enfermería en la niñez y adolescencia", "Generalidades del cuidado de enfermería del adulto y adulto mayor", "Cuidados de enfermería en el adulto y adulto mayor", "Cuidados de enfermería a personas con problemas quirúrgicos más frecuentes", "Procedimientos básicos del cuidado enfermero en pacientes adultos y adultos mayores", "Generalidades sobre el cuidado familiar y comunitario", "Bases para el cuidado familiar y comunitario", "La enfermería en el trabajo familiar y comunitario", "Educación para la salud", "Bases administrativas del cuidado", "Bases de investigación científica: metodología de investigación", "Bases epidemiológicas del cuidado: vigilancia epidemiológica"];

            // --- Smart Category Guessing ---
            const MEDICINE_CATEGORY_KEYWORDS = {
              "Cardiología": ["cardio", "angina", "infarto", "iam", "ecg", "stent", "fibrilación auricular", "insuficiencia cardiaca", "miocardio", "troponina", "bradicardia", "taquicardia", "presión arterial", "hipertensión", "ecocardiograma", "cateterismo", "marcapasos", "válvula", "aorta", "arteria coronaria"],
              "Dermatología": ["piel", "placas", "prurito", "dermatitis", "psoriasis", "melanoma", "nevus", "lesión cutánea", "queratosis", "urticaria", "acné", "eccema"],
              "Gastroenterología": ["abdomen", "hepatitis", "cirrosis", "ascitis", "colon", "diarrea", "hematoquezia", "melena", "pancreatitis", "ictericia", "disfagia", "reflujo", "esófago", "estómago", "intestino", "endoscopia", "colonoscopia", "úlcera", "crohn", "colitis"],
              "Endocrinología": ["tiroid", "hiper", "hipo", "diabetes", "cetoacidosis", "cortisol", "cushing", "addison", "prolactina", "insulina", "glucagón", "glándula", "suprarrenal", "pituitaria", "paratiroides"],
              "Hematología": ["anemia", "hemólisis", "leucemia", "linfoma", "trombosis", "hemofilia", "plaquetas", "coagulación", "hemoglobina", "hematocrito", "glóbulos rojos", "glóbulos blancos", "mieloma"],
              "Infectología": ["fiebre", "sepsis", "bacteremia", "antibiótico", "vih", "tuberculosis", "neumonía", "meningitis", "absceso", "virus", "bacteria", "hongo", "parásito", "cultivo", "antiviral", "antifúngico"],
              "Nefrología": ["riñón", "renal", "creatinina", "proteinuria", "hematuria", "glomerulo", "dialisis", "poliuria", "edema", "urea", "diuresis", "oliguria", "insuficiencia renal aguda", "insuficiencia renal crónica"],
              "Neurología": ["convuls", "ictus", "acv", "migraña", "epilepsia", "parkinson", "esclerosis", "paresia", "afasia", "nistagmo", "cefalea", "hemiparesia", "hemiplejia", "vértigo", "meninges", "líquido cefalorraquídeo", "glasgow"],
              "Neumología": ["asma", "epoc", "vni", "oxigeno", "espirometría", "bronco", "tos", "disnea", "hemoptisis", "pulmón", "pulmonar", "esputo", "sibilancias", "roncus", "crepitantes", "pleura"],
              "Reumatología": ["artritis", "lupus", "vasculitis", "gota", "espondilitis", "sicca", "raynaud", "anticuerpos", "artralgia", "mialgia", "factor reumatoide", "sjogren"],
              "Neonatologia": ["neonato", "recién nacido", "apgar", "hiperbilirrubinemia", "prematuro"],
              "Pediatria": ["niño", "pediátr", "lactante", "adolescente", "vacuna", "otitis", "faringitis"],
              "Ginecologia": ["gineco", "papanicolau", "vph", "metrorragia", "mioma", "ovario", "mamografía", "útero", "cérvix", "menstruación", "amenorrea"],
              "Obstetricia": ["gesta", "semanas", "embarazo", "parto", "preclampsia", "amniorrea", "feto", "dilatación", "borrado", "cesárea", "puerperio"],
              "Cirugia general": ["cirugía", "quirúrg", "abdomen agudo", "hernias", "apendicitis", "colecistitis", "laparotomía", "laparoscopia", "postoperatorio", "sutura"],
              "Oftalmologia": ["ojo", "conjuntivitis", "glaucoma", "retina", "visión", "agudeza visual", "córnea"],
              "Otorrinolaringología": ["oído", "otitis", "amigdal", "sinusitis", "faring", "ronquido", "epistaxis", "vértigo periférico", "hipoacusia"],
              "Traumatologia": ["fractura", "luxación", "rotuliana", "menisco", "columna", "osteoporosis", "hueso", "esguince", "articulación", "ligamento", "tendón", "ortopedia"],
              "Urologia": ["próstata", "litiasis", "cólico", "vejiga", "incontinencia", "disuria", "hematuria", "psa"],
              "Psiquiatría": ["depres", "ansiedad", "bipolar", "psicosis", "esquizofrenia", "suicidio", "antidepresivo", "antipsicótico"],
              "Salud Pública / Epidemiología": ["incidencia", "prevalencia", "riesgo relativo", "odds", "sesgo", "screening", "brotes", "epidemia", "pandemia"],
              "Bióetica": ["consentimiento", "autonomía", "beneficencia", "no maleficencia", "confidencialidad", "justicia distributiva"]
            };

            const NURSING_CATEGORY_KEYWORDS = {
              "Generalidades para el cuidado enfermero": ["cuidado enfermero", "fundamentos", "generalidades"],
              "Procedimientos básicos del cuidado enfermero": ["procedimiento", "técnica", "venoclisis", "cateterismo", "canalización"],
              "Proceso de atención en Enfermería": ["PAE", "proceso de atención", "valoración", "diagnóstico de enfermería", "NANDA", "NOC", "NIC"],
              "Bioseguridad": ["bioseguridad", "guantes", "mascarilla", "desinfección", "esterilización", "lavado de manos", "EPI"],
              "Ética en el ejercicio profesional": ["ética", "deontología", "código ético", "confidencialidad", "secreto profesional"],
              "Seguridad y calidad en el cuidado": ["seguridad del paciente", "calidad asistencial", "evento adverso", "error de medicación"],
              "Salud sexual y reproductiva": ["salud sexual", "salud reproductiva", "anticonceptivos", "ITS", "ETS", "planificación familiar"],
              "Salud sexual y reproductiva de la mujer": ["mujer", "papanicolau", "VPH", "salud ginecológica"],
              "Cuidados de enfermería en el embarazo, parto y puerperio": ["embarazo", "parto", "puerperio", "gestante", "feto", "lactancia materna", "cuidado prenatal"],
              "Cuidados gineco-obstétricos de la mujer": ["gineco-obstétrico", "cuidado ginecológico", "cuidado obstétrico"],
              "Cuidados de enfermería en el recién nacido": ["recién nacido", "neonato", "APGAR", "ictericia", "cuidado del cordón umbilical"],
              "Generalidades sobre niñez y adolescencia": ["niñez", "adolescencia", "crecimiento y desarrollo", "desarrollo infantil"],
              "Cuidados de enfermería en la niñez y adolescencia": ["pediatría", "cuidado pediátrico", "vacunación infantil", "salud escolar"],
              "Generalidades del cuidado de enfermería del adulto y adulto mayor": ["adulto", "adulto mayor", "anciano", "envejecimiento", "geriatría", "gerontología"],
              "Cuidados de enfermería en el adulto y adulto mayor": ["cuidado del adulto", "enfermedad crónica", "polifarmacia", "cuidado geriátrico"],
              "Cuidados de enfermería a personas con problemas quirúrgicos más frecuentes": ["quirúrgico", "cirugía", "preoperatorio", "postoperatorio", "cuidado de herida", "drenaje"],
              "Procedimientos básicos del cuidado enfermero en pacientes adultos y adultos mayores": ["procedimiento en adulto", "sonda nasogástrica", "curación de úlceras"],
              "Generalidades sobre el cuidado familiar y comunitario": ["salud familiar", "salud comunitaria", "atención primaria de salud"],
              "Bases para el cuidado familiar y comunitario": ["visita domiciliaria", "modelo de atención integral"],
              "La enfermería en el trabajo familiar y comunitario": ["enfermería comunitaria", "promoción de la salud", "prevención de la enfermedad"],
              "Educación para la salud": ["educación sanitaria", "charla educativa", "fomento del autocuidado"],
              "Bases administrativas del cuidado": ["administración de servicios", "gestión del cuidado", "liderazgo en enfermería"],
              "Bases de investigación científica: metodología de investigación": ["investigación en enfermería", "metodología", "estudio científico"],
              "Bases epidemiológicas del cuidado: vigilancia epidemiológica": ["epidemiología", "vigilancia epidemiológica", "notificación de enfermedades"]
            };

            let userMedicineKeywords = {};
            let userNursingKeywords = {};

            function stripHtml(html) {
                const doc = new DOMParser().parseFromString(html || '', 'text/html');
                return doc.body.textContent || "";
            }
            function normalize(s) {
              return (s || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }
            
            function guessCategoryForQuestion(q, career) {
                const text = normalize(stripHtml([q.text, q.option_a, q.option_b, q.option_c, q.option_d, q.justification].join(" ")));
                let keywordSet = {};
                let careerNormalized = (career || "").toLowerCase();

                if (careerNormalized === "medicina") keywordSet = userMedicineKeywords;
                else if (careerNormalized === "enfermeria") keywordSet = userNursingKeywords;
                else return ""; // No hay categorías específicas para Odontología o si la carrera no está definida

                let bestCat = null, bestScore = 0;
                for (const [cat, kws] of Object.entries(keywordSet)) {
                    let score = 0;
                    for (const kw of kws) {
                        const re = new RegExp(`\\b${normalize(kw)}`, "g");
                        const matches = text.match(re);
                        if (matches) score += matches.length;
                    }
                    if (score > bestScore) { bestScore = score; bestCat = cat; }
                }
                return bestScore > 0 ? bestCat : "";
            }

            // --- Core Functions ---

            function renderHeader() {
                tableHeader.innerHTML = '';
                
                // Title Row
                const titleContent = document.createElement('div');
                titleContent.className = 'flex items-center bg-gray-50 font-medium text-xs text-gray-500 uppercase tracking-wider';
                titleContent.style.width = `${totalWidth}px`;

                TABLE_HEADERS.forEach(h => {
                    const cell = document.createElement('div');
                    cell.className = 'px-3 py-3 border-r border-gray-200 flex items-center justify-center';
                    cell.style.flex = `0 0 ${h.width}px`;
                    cell.innerHTML = h.label;
                    titleContent.appendChild(cell);
                });
                tableHeader.appendChild(titleContent);
                
                // Filter Row
                const filterContent = document.createElement('div');
                filterContent.id = 'filter-row';
                filterContent.className = `flex items-center bg-gray-100 p-1 ${showFilters ? '' : 'hidden'}`;
                filterContent.style.width = `${totalWidth}px`;
                TABLE_HEADERS.forEach(h => {
                    const cell = document.createElement('div');
                    cell.className = 'px-1';
                    cell.style.flex = `0 0 ${h.width}px`;
                    if (!['select', 'rowNum', 'actions'].includes(h.key)) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = `Filtrar...`;
                        input.className = 'w-full p-1 border rounded-md text-xs filter-input';
                        input.dataset.key = h.key;
                        input.value = filters[h.key] || '';
                        cell.appendChild(input);
                    }
                    filterContent.appendChild(cell);
                });
                tableHeader.appendChild(filterContent);
                
                document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedRows = new Set(filteredIndices);
                    } else {
                        selectedRows.clear();
                    }
                    updateAdvancedToolbar();
                    renderVirtualRows();
                });
            }

            function renderVirtualRows() {
                const scrollTop = tableBodyContainer.scrollTop;
                const containerHeight = tableBodyContainer.clientHeight;
                
                const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - OVERSCAN_COUNT);
                const endIndex = Math.min(filteredIndices.length, Math.ceil((scrollTop + containerHeight) / ROW_HEIGHT) + OVERSCAN_COUNT);

                tableBodySizer.style.height = `${filteredIndices.length * ROW_HEIGHT}px`;
                tableBody.innerHTML = '';

                for (let i = startIndex; i < endIndex; i++) {
                    const originalIndex = filteredIndices[i];
                    const question = questions[originalIndex];
                    const row = document.createElement('div');
                    const isSelected = selectedRows.has(originalIndex);
                    row.className = `absolute top-0 left-0 w-full ${isSelected ? 'selected-row' : ''}`;
                    row.style.top = `${i * ROW_HEIGHT}px`;
                    row.style.height = `${ROW_HEIGHT}px`;
                    row.dataset.index = originalIndex;

                    const rowContent = document.createElement('div');
                    rowContent.className = 'flex items-stretch border-b border-gray-200 h-full';
                    rowContent.style.width = `${totalWidth}px`;

                    TABLE_HEADERS.forEach(header => {
                        const cell = document.createElement('div');
                        cell.className = 'px-2 py-1 flex items-center border-r border-gray-200 relative';
                        cell.style.flex = `0 0 ${header.width}px`;

                        if (header.key === 'select') {
                            cell.innerHTML = `<div class="w-full h-full flex items-center justify-center"><input type="checkbox" class="row-checkbox h-4 w-4" ${isSelected ? 'checked' : ''}></div>`;
                        } else if (header.key === 'rowNum') {
                            cell.innerHTML = `<div class="w-full h-full flex items-center justify-center text-sm text-gray-500">${i + 1}</div>`;
                        } else if (header.key === 'actions') {
                            cell.innerHTML = `<div class="w-full h-full flex items-center justify-center space-x-1">
                                <button class="p-2 text-blue-600 hover:text-blue-800 rounded-full transition-colors edit-btn" title="Editar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                                </button>
                                <button class="p-2 text-red-600 hover:text-red-800 rounded-full transition-colors delete-btn" title="Eliminar Fila">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>`;
                        } else {
                            const textarea = document.createElement('textarea');
                            textarea.className = 'w-full h-full p-2 border-transparent rounded-lg focus:ring-1 focus:ring-blue-400 focus:border-blue-500 text-sm bg-transparent hover:bg-gray-50 focus:bg-white resize-y cell-textarea';
                            textarea.value = question[header.key] || '';
                            textarea.dataset.field = header.key;
                            cell.appendChild(textarea);
                             if (header.key === 'category') {
                                const classifyBtn = document.createElement('button');
                                classifyBtn.className = 'absolute top-2 right-2 p-1 text-gray-400 hover:text-blue-600 classify-btn';
                                classifyBtn.title = 'Clasificar rápido';
                                classifyBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 14h.01M7 17h5a2 2 0 012 2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1a2 2 0 012-2z"></path></svg>`;
                                cell.appendChild(classifyBtn);
                            }
                        }
                        rowContent.appendChild(cell);
                    });
                    row.appendChild(rowContent);
                    tableBody.appendChild(row);
                }
            }
            
            function renderEmptyState() {
                tableBodySizer.style.height = 'auto';
                tableBody.innerHTML = `<div class="flex items-center justify-center h-full p-16"><div class="text-center"><h3 class="text-lg font-medium text-gray-600">Aún no hay preguntas</h3><p class="text-gray-500 mt-1">Haz clic en "Importar" para comenzar.</p></div></div>`;
            }
            
            function applyFiltersAndSearch() {
                const normalizedSearchTerm = normalize(searchTerm);

                filteredIndices = questions
                    .map((_, index) => index)
                    .filter(index => {
                        const q = questions[index];
                        
                        if (normalizedSearchTerm) {
                            const searchableString = normalize(Object.values(q).join(' '));
                            if (!searchableString.includes(normalizedSearchTerm)) return false;
                        }

                        for (const key in filters) {
                            const filterValue = normalize(filters[key]);
                            if (filterValue && !normalize(q[key]).includes(filterValue)) return false;
                        }
                        return true;
                    });
                
                updateUI();
            }

            function updateUI() {
                const hasVisibleQuestions = filteredIndices.length > 0;
                exportBtn.disabled = !hasVisibleQuestions;
                
                if (hasVisibleQuestions) {
                    if (currentView === 'table') {
                        renderVirtualRows();
                    } else {
                        renderTextView(true); // pass flag to use filtered data
                    }
                } else if (questions.length > 0 && !hasVisibleQuestions) {
                    tableBodySizer.style.height = 'auto';
                    tableBody.innerHTML = `<div class="flex items-center justify-center h-full p-16"><div class="text-center"><h3 class="text-lg font-medium text-gray-600">No se encontraron resultados</h3><p class="text-gray-500 mt-1">Intenta ajustar tu búsqueda o filtros.</p></div></div>`;
                } else {
                    renderEmptyState();
                }
                updateAdvancedToolbar();
                saveState();
            }

            function showError(message) {
                errorContainer.textContent = message;
                errorContainer.classList.remove('hidden');
            }

            function hideError() {
                errorContainer.classList.add('hidden');
            }

            function processXmlContent(xmlString) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                    const parserError = xmlDoc.querySelector("parsererror");
                    if (parserError) throw new Error("Error al analizar el archivo XML. Formato incorrecto.");

                    const questionNodes = xmlDoc.querySelectorAll("question[type='multichoice']");
                    const categoryNodes = Array.from(xmlDoc.querySelectorAll("question[type='category']"));
                    let currentCategory = "General";
                    
                    const parsedQuestions = Array.from(questionNodes).map(node => {
                        const questionTextNode = node.querySelector("questiontext > text");
                        
                        const precedingCategories = categoryNodes.filter(catNode => catNode.compareDocumentPosition(node) & Node.DOCUMENT_POSITION_FOLLOWING);
                        if(precedingCategories.length > 0){
                           const categoryText = precedingCategories[precedingCategories.length - 1].querySelector("category > text")?.textContent;
                           if(categoryText) currentCategory = categoryText.replace('$course$/', '').split('/').pop().trim() || "General";
                        }

                        const answerNodes = node.querySelectorAll("answer");
                        let justificationNode = node.querySelector("incorrectfeedback > text") || node.querySelector("generalfeedback > text");
                        const options = [];
                        let correctAnswerId = '';
                        
                        answerNodes.forEach((ans, index) => {
                            options.push(ans.querySelector("text")?.textContent || '');
                            if (parseFloat(ans.getAttribute("fraction")) === 100) correctAnswerId = String.fromCharCode(97 + index); 
                        });
                        
                        const tempQuestion = { 
                          text: questionTextNode?.textContent || '',
                          option_a: options[0] || '', option_b: options[1] || '',
                          option_c: options[2] || '', option_d: options[3] || '',
                          justification: justificationNode?.textContent || ''
                        };

                        return {
                            id: `q_${Date.now()}_${Math.random()}`, ...tempQuestion,
                            correctAnswerId, 
                            category: currentCategory, 
                            year: new Date().getFullYear().toString(),
                            examType: '', 
                            topic: currentCategory, 
                            career: ''
                        };
                    });

                    if (parsedQuestions.length === 0) {
                        showError("No se encontraron preguntas de opción múltiple en el archivo XML.");
                        questions = [];
                    } else {
                        hideError();
                        questions = parsedQuestions;
                    }
                    selectedRows.clear();
                    pushState(questions);
                    applyFiltersAndSearch();
                } catch (e) {
                    console.error("XML Parsing Error:", e);
                    showError(e.message || "Ocurrió un error desconocido al procesar el archivo.");
                    questions = [];
                    applyFiltersAndSearch();
                }
            }
            
            function processCsvContent(csvString, append = false) {
                try {
                    const parseCSV = (str) => {
                        const result = [];
                        let row = [];
                        let field = '';
                        let inQuotes = false;
                        str = str.trim() + '\n';
                        for (let i = 0; i < str.length; i++) {
                            const char = str[i];
                            if (inQuotes) {
                                if (char === '"') {
                                    if (str[i + 1] === '"') { field += '"'; i++; } else { inQuotes = false; }
                                } else { field += char; }
                            } else {
                                if (char === '"') { inQuotes = true; }
                                else if (char === ',') { row.push(field); field = ''; }
                                else if (char === '\n' || char === '\r') {
                                    if (str[i + 1] === '\n' && char === '\r') { i++; }
                                    row.push(field); result.push(row); row = []; field = '';
                                } else { field += char; }
                            }
                        }
                        return result;
                    };

                    const data = parseCSV(csvString);
                    let headers = data.shift();
                    
                    if (headers && headers.length > 0) {
                        if (headers[0].charCodeAt(0) === 0xFEFF) {
                            headers[0] = headers[0].substring(1);
                        }
                        headers = headers.map(h => h.trim().replace(/"/g, ''));
                    }

                    const requiredHeaders = TABLE_HEADERS.filter(h => !['actions', 'rowNum', 'select'].includes(h.key)).map(h => h.key);

                    if (!headers || headers.length !== requiredHeaders.length || !requiredHeaders.every((h, i) => headers[i] === h)) {
                        throw new Error("El archivo CSV no tiene el formato o las cabeceras correctas. El orden debe ser: " + requiredHeaders.join(', '));
                    }

                    const parsedQuestions = data.map(values => {
                        if (values.length === 0 || (values.length === 1 && values[0] === '')) return null;
                        if (values.length !== headers.length) { console.warn("Skipping malformed row:", values); return null; }
                        const question = {};
                        headers.forEach((header, i) => { question[header] = values[i] || ''; });
                        question.id = `q_${Date.now()}_${Math.random()}`;
                        return question;
                    }).filter(Boolean);
                    
                    if (append) {
                        pushState(questions);
                        questions.push(...parsedQuestions);
                    } else {
                        questions = parsedQuestions;
                        selectedRows.clear();
                        pushState(questions);
                    }
                    
                    hideError();
                    applyFiltersAndSearch();

                } catch(e) {
                    console.error("CSV Parsing Error:", e);
                    showError(e.message || "Ocurrió un error al procesar el archivo CSV.");
                }
            }


            function exportToCsv() {
                if (filteredIndices.length === 0) return;
                const headers = TABLE_HEADERS.filter(h => !['actions', 'rowNum', 'select'].includes(h.key)).map(h => h.key);
                const sanitize = (data) => {
                    let text = (data || '').toString().replace(/<[^>]*>/g, '').replace(/"/g, '""');
                    return /[,"]|\n/.test(text) ? `"${text}"` : text;
                };
                const csvRows = [headers.join(','), ...filteredIndices.map(i => headers.map(h => sanitize(questions[i][h])).join(','))];
                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.csv`;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            // --- Event Listeners ---
            clearAllBtn.addEventListener('click', () => {
                if(questions.length > 0) {
                    pushState(questions);
                    questions = [];
                    selectedRows.clear();
                    applyFiltersAndSearch();
                }
            });

            importXmlBtn.addEventListener('click', () => xmlFileInput.click());
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            importPasteBtn.addEventListener('click', () => {
                pasteCsvArea.value = '';
                pasteModalContainer.classList.remove('hidden');
            });

            xmlFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.type === "text/xml") {
                        fileName = file.name.replace(/\.xml$/, '');
                        appTitle.textContent = fileName;
                        const reader = new FileReader();
                        reader.onload = (ev) => processXmlContent(ev.target.result);
                        reader.readAsText(file);
                    } else { showError("Por favor, sube un archivo XML válido."); }
                }
                e.target.value = null;
            });

            csvFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.type === "text/csv" || file.name.endsWith('.csv')) {
                         fileName = file.name.replace(/\.csv$/, '');
                         appTitle.textContent = fileName;
                        const reader = new FileReader();
                        reader.onload = (ev) => processCsvContent(ev.target.result);
                        reader.readAsText(file);
                    } else { showError("Por favor, sube un archivo CSV válido."); }
                }
                e.target.value = null;
            });


            exportBtn.addEventListener('click', exportToCsv);
            
            tableBodyContainer.addEventListener('scroll', (e) => {
                tableHeader.scrollLeft = e.currentTarget.scrollLeft;
                renderVirtualRows();
            });
            window.addEventListener('resize', renderVirtualRows);

            tableBody.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const field = e.target.dataset.field;
                    const index = parseInt(e.target.closest('[data-index]').dataset.index, 10);
                    const value = e.target.value;

                    clearTimeout(debounceTimers[index + field]);
                    debounceTimers[index + field] = setTimeout(() => {
                        if (questions[index] && questions[index][field] !== value) {
                            pushState(questions);
                            questions[index][field] = value;
                            saveState();
                        }
                    }, 500);
                }
            });

            tableBody.addEventListener('click', (e) => {
                const rowElement = e.target.closest('[data-index]');
                if (!rowElement) return;
                const index = parseInt(rowElement.dataset.index, 10);

                if (e.target.classList.contains('row-checkbox')) {
                    const isChecked = e.target.checked;
                    if (e.shiftKey && lastCheckedIndex !== null) {
                        const lastPos = filteredIndices.indexOf(lastCheckedIndex);
                        const currentPos = filteredIndices.indexOf(index);
                        if (lastPos > -1 && currentPos > -1) {
                            const start = Math.min(lastPos, currentPos);
                            const end = Math.max(lastPos, currentPos);
                            for (let i = start; i <= end; i++) {
                                const originalIdx = filteredIndices[i];
                                if (isChecked) selectedRows.add(originalIdx);
                                else selectedRows.delete(originalIdx);
                            }
                        }
                    } else {
                        if (isChecked) selectedRows.add(index);
                        else selectedRows.delete(index);
                    }
                    lastCheckedIndex = index;
                    updateAdvancedToolbar();
                    renderVirtualRows();
                }
                if (e.target.closest('.edit-btn')) { openModal(index); }
                if (e.target.closest('.classify-btn')) { showClassifyPopup(e.target.closest('.classify-btn'), index); }
                if (e.target.closest('.delete-btn')) {
                    pushState(questions);
                    questions.splice(index, 1);
                    selectedRows.delete(index);
                    const newSelectedRows = new Set();
                    selectedRows.forEach(i => {
                        if (i > index) newSelectedRows.add(i - 1);
                        else if (i < index) newSelectedRows.add(i);
                    });
                    selectedRows = newSelectedRows;
                    applyFiltersAndSearch();
                }
            });
            
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                applyFiltersAndSearch();
            });

            toggleFiltersBtn.addEventListener('click', () => {
                showFilters = !showFilters;
                renderHeader(); // Re-render to show/hide filter row
                if(showFilters) {
                    tableHeader.querySelector('.filter-input').focus();
                }
            });

            tableHeader.addEventListener('input', (e) => {
                if (e.target.classList.contains('filter-input')) {
                    const key = e.target.dataset.key;
                    const value = e.target.value;
                    if (value) {
                        filters[key] = value;
                    } else {
                        delete filters[key];
                    }
                    applyFiltersAndSearch();
                }
            });

            settingsBtn.addEventListener('click', () => settingsBar.classList.toggle('max-h-0'));
            globalYearInput.value = new Date().getFullYear();

            applyMassiveEditBtn.addEventListener('click', () => {
                if(questions.length === 0) return alert("Importa un archivo primero.");
                pushState(questions);
                const year = globalYearInput.value;
                const examType = globalExamInput.value;
                const category = globalCategoryInput.value;
                const topic = globalTopicInput.value;
                const career = globalCareerInput.value;

                questions.forEach(q => {
                    if (year.trim()) q.year = year;
                    if (examType.trim()) q.examType = examType;
                    if (category.trim()) q.category = category;
                    if (topic.trim()) q.topic = topic;
                    if (career.trim()) q.career = career;
                });
                applyFiltersAndSearch();
                alert("¡Campos actualizados para todas las preguntas!");
            });

            // --- Modal Logic ---
            function openModal(index) {
                editingQuestionIndex = index;
                renderModalContent();
                modalContainer.classList.remove('hidden');
            }
            
            function renderModalContent() {
                const question = questions[editingQuestionIndex];
                if (!question) return;

                modalTitle.textContent = `Editando Pregunta ${editingQuestionIndex + 1} de ${questions.length}`;
                modalContent.innerHTML = '';
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4';

                TABLE_HEADERS.filter(h => !['actions', 'rowNum', 'select'].includes(h.key)).forEach(h => {
                    const isTextarea = ['text', 'justification'].includes(h.key);
                    const isFullWidth = ['text', 'justification'].includes(h.key);
                    
                    const fieldWrapper = document.createElement('div');
                    if (isFullWidth) { fieldWrapper.className = 'md:col-span-2'; }

                    const label = document.createElement('label');
                    label.className = 'block text-sm font-medium text-gray-700 mb-1';
                    label.textContent = h.label;
                    
                    let inputElement;
                    if (isTextarea) {
                        inputElement = document.createElement('textarea');
                        inputElement.rows = h.key === 'text' ? 4 : 3;
                    } else {
                        inputElement = document.createElement('input');
                        inputElement.type = 'text';
                    }
                    inputElement.className = 'w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm';
                    inputElement.dataset.field = h.key;
                    inputElement.value = question[h.key] || '';

                    fieldWrapper.appendChild(label);
                    
                    if (h.key === 'category') {
                        const categoryInputWrapper = document.createElement('div');
                        categoryInputWrapper.className = 'relative';
                        const classifyBtn = document.createElement('button');
                        classifyBtn.className = 'absolute top-1/2 right-2 -translate-y-1/2 p-1 text-gray-400 hover:text-blue-600 modal-classify-btn';
                        classifyBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm0 14h.01M7 17h5a2 2 0 012 2v1a2 2 0 01-2 2H7a2 2 0 01-2-2v-1a2 2 0 012-2z"></path></svg>`;
                        categoryInputWrapper.appendChild(inputElement);
                        categoryInputWrapper.appendChild(classifyBtn);
                        fieldWrapper.appendChild(categoryInputWrapper);
                    } else {
                         fieldWrapper.appendChild(inputElement);
                    }
                    
                    contentWrapper.appendChild(fieldWrapper);
                });
                modalContent.appendChild(contentWrapper);
                
                modalPrevBtn.disabled = editingQuestionIndex === 0;
                modalNextBtn.disabled = editingQuestionIndex === questions.length - 1;
            }

            function saveCurrentModalState() {
                if (editingQuestionIndex === null) return;
                pushState(questions);
                const updatedQuestion = { ...questions[editingQuestionIndex] };
                modalContent.querySelectorAll('[data-field]').forEach(input => {
                    updatedQuestion[input.dataset.field] = input.value;
                });
                questions[editingQuestionIndex] = updatedQuestion;
            }

            function closeModal() {
                modalContainer.classList.add('hidden');
                editingQuestionIndex = null;
                applyFiltersAndSearch();
            }

            modalSaveBtn.addEventListener('click', () => {
                saveCurrentModalState();
                closeModal();
            });

            modalCancelBtn.addEventListener('click', closeModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) closeModal();
            });

            modalDeleteBtn.addEventListener('click', () => {
                if (editingQuestionIndex !== null) {
                    pushState(questions);
                    questions.splice(editingQuestionIndex, 1);
                    selectedRows.delete(editingQuestionIndex);
                    const newSelectedRows = new Set();
                    selectedRows.forEach(i => {
                        if (i > editingQuestionIndex) newSelectedRows.add(i - 1);
                        else if (i < editingQuestionIndex) newSelectedRows.add(i);
                    });
                    selectedRows = newSelectedRows;
                    closeModal();
                }
            });
            
            modalContent.addEventListener('click', (e) => {
                const classifyButton = e.target.closest('.modal-classify-btn');
                if (classifyButton) {
                    showClassifyPopup(classifyButton, editingQuestionIndex, true);
                }
            });

            modalPrevBtn.addEventListener('click', () => {
                if (editingQuestionIndex > 0) {
                    saveCurrentModalState();
                    const currentScroll = tableBodyContainer.scrollTop;
                    applyFiltersAndSearch(); // Re-apply to keep view consistent
                    tableBodyContainer.scrollTop = currentScroll;

                    const prevFilteredIndex = filteredIndices.indexOf(editingQuestionIndex) - 1;
                    if(prevFilteredIndex >= 0) {
                        editingQuestionIndex = filteredIndices[prevFilteredIndex];
                        renderModalContent();
                    }
                }
            });

            modalNextBtn.addEventListener('click', () => {
                if (editingQuestionIndex < questions.length - 1) {
                    saveCurrentModalState();
                    const currentScroll = tableBodyContainer.scrollTop;
                    applyFiltersAndSearch();
                    tableBodyContainer.scrollTop = currentScroll;
                    
                    const nextFilteredIndex = filteredIndices.indexOf(editingQuestionIndex) + 1;
                    if(nextFilteredIndex < filteredIndices.length){
                        editingQuestionIndex = filteredIndices[nextFilteredIndex];
                        renderModalContent();
                    }
                }
            });
            
            // --- Paste CSV Modal Logic ---
            pasteCancelBtn.addEventListener('click', () => pasteModalContainer.classList.add('hidden'));
            pasteModalContainer.addEventListener('click', (e) => {
                if(e.target === pasteModalContainer) pasteModalContainer.classList.add('hidden');
            });
            pasteProcessBtn.addEventListener('click', () => {
                const text = pasteCsvArea.value;
                if(text.trim()){
                    processCsvContent(text, true); // Append pasted content
                }
                pasteModalContainer.classList.add('hidden');
            });

            // --- Quick Classify Popup Logic ---
            let currentClassifyIndex = null;
            let isModalClassify = false;

            function showClassifyPopup(button, index, isModal = false) {
                currentClassifyIndex = index;
                isModalClassify = isModal;
                
                classifySearch.value = '';
                renderClassifyList();
                classifyPopup.classList.remove('hidden');
                classifySearch.focus();
            }
            
            function renderClassifyList(filter = '') {
                classifyList.innerHTML = '';
                const career = questions[currentClassifyIndex]?.career;
                let categoryList = (career === 'Enfermeria') ? NURSING_CATEGORIES : MEDICINE_CATEGORIES;
                
                const filteredCategories = categoryList.filter(cat => cat.toLowerCase().includes(filter.toLowerCase()));
                
                filteredCategories.forEach(cat => {
                    const catButton = document.createElement('button');
                    catButton.className = 'block w-full text-left px-4 py-2 text-md hover:bg-gray-100 rounded-md focus:bg-blue-100 focus:outline-none';
                    catButton.textContent = cat;
                    catButton.dataset.category = cat;
                    classifyList.appendChild(catButton);
                });
            }

            function hideClassifyPopup() {
                classifyPopup.classList.add('hidden');
                currentClassifyIndex = null;
                isModalClassify = false;
            }

            classifySearch.addEventListener('input', (e) => {
                renderClassifyList(e.target.value);
            });
            
            classifySearch.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const firstButton = classifyList.querySelector('button');
                    if (firstButton) firstButton.focus();
                } else if (e.key === 'Escape') {
                    hideClassifyPopup();
                }
            });

            classifyList.addEventListener('keydown', (e) => {
                const currentButton = document.activeElement;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextButton = currentButton.nextElementSibling;
                    if (nextButton) nextButton.focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevButton = currentButton.previousElementSibling;
                    if (prevButton) prevButton.focus();
                    else classifySearch.focus();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    currentButton.click();
                } else if (e.key === 'Escape') {
                    hideClassifyPopup();
                }
            });

            classifyList.addEventListener('click', (e) => {
                if (e.target.dataset.category && currentClassifyIndex !== null) {
                    pushState(questions);
                    const selectedCategory = e.target.dataset.category;
                    if (isModalClassify) {
                        modalContent.querySelector('[data-field="category"]').value = selectedCategory;
                        modalContent.querySelector('[data-field="topic"]').value = selectedCategory;
                    } else {
                        questions[currentClassifyIndex].category = selectedCategory;
                        questions[currentClassifyIndex].topic = selectedCategory;
                        applyFiltersAndSearch();
                    }
                    hideClassifyPopup();
                }
            });

            classifyPopup.addEventListener('click', (e) => {
                if (e.target === classifyPopup) {
                    hideClassifyPopup();
                }
            });

            // --- Advanced Toolbar Logic ---
            function updateAdvancedToolbar() {
                if (selectedRows.size > 0) {
                    selectionCount.textContent = `${selectedRows.size} fila${selectedRows.size > 1 ? 's' : ''} seleccionada${selectedRows.size > 1 ? 's' : ''}`;
                    advancedToolbar.classList.remove('hidden');
                } else {
                    advancedToolbar.classList.add('hidden');
                }
            }

            batchDeleteBtn.addEventListener('click', () => {
                pushState(questions);
                questions = questions.filter((_, index) => !selectedRows.has(index));
                selectedRows.clear();
                applyFiltersAndSearch();
            });

            batchEditBtn.addEventListener('click', () => {
                document.getElementById('batch-year').value = '';
                document.getElementById('batch-exam').value = '';
                document.getElementById('batch-category').value = '';
                document.getElementById('batch-topic').value = '';
                document.getElementById('batch-career-modal').value = '';
                batchEditModalContainer.classList.remove('hidden');
            });

            batchEditCancelBtn.addEventListener('click', () => batchEditModalContainer.classList.add('hidden'));
            batchEditApplyBtn.addEventListener('click', () => {
                pushState(questions);
                const year = document.getElementById('batch-year').value;
                const examType = document.getElementById('batch-exam').value;
                const category = document.getElementById('batch-category').value;
                const topic = document.getElementById('batch-topic').value;
                const career = document.getElementById('batch-career-modal').value;

                selectedRows.forEach(index => {
                    if (year.trim()) questions[index].year = year;
                    if (examType.trim()) questions[index].examType = examType;
                    if (category.trim()) questions[index].category = category;
                    if (topic.trim()) questions[index].topic = topic;
                    if (career.trim()) questions[index].career = career;
                });
                
                batchEditModalContainer.classList.add('hidden');
                applyFiltersAndSearch();
            });
            
            modalAutoclassifyBtn.addEventListener('click', () => {
                if (editingQuestionIndex === null) return;
                const currentQuestion = {};
                modalContent.querySelectorAll('[data-field]').forEach(input => {
                    currentQuestion[input.dataset.field] = input.value;
                });

                const predictedCategory = guessCategoryForQuestion(currentQuestion, currentQuestion.career);
                if (predictedCategory) {
                    modalContent.querySelector('[data-field="category"]').value = predictedCategory;
                    modalContent.querySelector('[data-field="topic"]').value = predictedCategory;
                } else {
                    alert('No se pudo determinar una categoría clara para esta pregunta.');
                }
            });

            autoclassifyBtn.addEventListener('click', () => {
              if (questions.length === 0) return alert("Importa un archivo primero.");
              pushState(questions);
              let changed = 0;
              questions.forEach(q => {
                const predictedCategory = guessCategoryForQuestion(q, q.career);
                if (predictedCategory) { 
                    q.category = predictedCategory; 
                    q.topic = predictedCategory; 
                    changed++; 
                }
              });
              applyFiltersAndSearch();
              alert(`Auto-clasificación de categoría aplicada. Filas actualizadas: ${changed}`);
            });

            // --- History (Undo/Redo) and Autosave Logic ---
            function pushState(state) {
                history = history.slice(0, historyIndex + 1);
                history.push(JSON.parse(JSON.stringify(state)));
                historyIndex++;
                updateUndoRedoButtons();
            }

            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= history.length - 1;
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    questions = JSON.parse(JSON.stringify(history[historyIndex]));
                    applyFiltersAndSearch();
                    updateUndoRedoButtons();
                }
            }

            function redo() {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    questions = JSON.parse(JSON.stringify(history[historyIndex]));
                    applyFiltersAndSearch();
                    updateUndoRedoButtons();
                }
            }
            
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
                if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
            });

            function saveState(manual = false) {
                try {
                    localStorage.setItem('moodleQuestionsAutosave', JSON.stringify(questions));
                    localStorage.setItem('moodleFilenameAutosave', fileName);
                    if(manual) {
                        saveFeedback.classList.remove('fade-out');
                        void saveFeedback.offsetWidth; // Trigger reflow
                        saveFeedback.classList.add('fade-out');
                    }
                } catch (e) {
                    console.error("Error saving state to localStorage:", e);
                }
            }

            function loadState() {
                try {
                    const savedState = localStorage.getItem('moodleQuestionsAutosave');
                    if (savedState) {
                        questions = JSON.parse(savedState);
                        fileName = localStorage.getItem('moodleFilenameAutosave') || 'Editor de Preguntas Moodle';
                        appTitle.textContent = fileName;
                        pushState(questions);
                    } else {
                        pushState([]);
                    }
                } catch (e) {
                    console.error("Error loading state from localStorage:", e);
                    questions = [];
                    pushState([]);
                }
            }

            saveBtn.addEventListener('click', () => saveState(true));

            window.addEventListener('beforeunload', (e) => {
                if (questions.length > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });


            // --- View Toggling Logic ---
            function questionsToPlainText(useFiltered = false) {
                const questionsToConvert = useFiltered ? filteredIndices.map(i => questions[i]) : questions;
                return questionsToConvert.map((q, i) => {
                    return `## PREGUNTA ${i + 1} ##\n` +
                           `TEXTO: ${stripHtml(q.text || '')}\n` +
                           `A: ${stripHtml(q.option_a || '')}\n` +
                           `B: ${stripHtml(q.option_b || '')}\n` +
                           `C: ${stripHtml(q.option_c || '')}\n` +
                           `D: ${stripHtml(q.option_d || '')}\n` +
                           `RESPUESTA: ${stripHtml(q.correctAnswerId || '')}\n` +
                           `CATEGORIA: ${stripHtml(q.category || '')}\n` +
                           `AÑO: ${stripHtml(q.year || '')}\n` +
                           `TIPO_EXAMEN: ${stripHtml(q.examType || '')}\n` +
                           `TEMA: ${stripHtml(q.topic || '')}\n` +
                           `JUSTIFICACION: ${stripHtml(q.justification || '')}\n` +
                           `CARRERA: ${stripHtml(q.career || '')}\n` +
                           `--------------------`;
                }).join('\n\n');
            }
            
            function renderTextView(useFiltered = false){
                 textViewArea.value = questionsToPlainText(useFiltered);
            }

            function plainTextToQuestions(text) {
                const newQuestions = [];
                const questionBlocks = text.split('--------------------');
                
                questionBlocks.forEach((block) => {
                    if (block.trim() === '') return;

                    const newQ = { id: `q_${Date.now()}_${Math.random()}` };
                    const lines = block.trim().split('\n');
                    let currentField = null;
                    
                    const fieldMap = {
                        "TEXTO": "text", "A": "option_a", "B": "option_b", "C": "option_c", "D": "option_d",
                        "RESPUESTA": "correctAnswerId", "CATEGORIA": "category", "AÑO": "year",
                        "TIPO_EXAMEN": "examType", "TEMA": "topic", "JUSTIFICACION": "justification", "CARRERA": "career"
                    };

                    for (const line of lines) {
                        if (line.startsWith('## PREGUNTA')) continue;
                        
                        const match = line.match(/^([A-Z_]+):\s*(.*)/);
                        
                        if (match) {
                            const key = match[1];
                            const value = match[2];
                            
                            if (fieldMap[key]) {
                                currentField = fieldMap[key];
                                newQ[currentField] = value;
                            } else if (currentField && (currentField === 'text' || currentField === 'justification')) {
                                newQ[currentField] += '\n' + line;
                            }
                        } else {
                            if (currentField && (currentField === 'text' || currentField === 'justification')) {
                                newQ[currentField] += '\n' + line;
                            }
                        }
                    }
                    newQuestions.push(newQ);
                });
                return newQuestions;
            }

            toggleViewBtn.addEventListener('click', () => {
                if (currentView === 'table') {
                    renderTextView(true);
                    tableView.classList.add('hidden');
                    textView.classList.remove('hidden');
                    tableViewIcon.classList.add('hidden');
                    textViewIcon.classList.remove('hidden');
                    currentView = 'text';
                } else {
                    pushState(questions);
                    questions = plainTextToQuestions(textViewArea.value);
                    textView.classList.add('hidden');
                    tableView.classList.remove('hidden');
                    textViewIcon.classList.add('hidden');
                    tableViewIcon.classList.remove('hidden');
                    currentView = 'table';
                    applyFiltersAndSearch();
                }
            });
            
            // --- Editable Title Logic ---
            appTitle.addEventListener('dblclick', () => {
                const currentTitle = appTitle.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTitle;
                input.className = 'text-2xl font-bold text-gray-800 bg-gray-100 border rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-blue-500';

                const saveTitle = () => {
                    const newTitle = input.value.trim();
                    if (newTitle) {
                        fileName = newTitle;
                        appTitle.textContent = newTitle;
                    }
                    titleContainer.innerHTML = '';
                    titleContainer.appendChild(appTitle);
                    saveState(true);
                };

                input.addEventListener('blur', saveTitle);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveTitle();
                    } else if (e.key === 'Escape') {
                        titleContainer.innerHTML = '';
                        titleContainer.appendChild(appTitle);
                    }
                });

                titleContainer.innerHTML = '';
                titleContainer.appendChild(input);
                input.focus();
                input.select();
            });

            // --- Keywords Editor Logic ---
            function loadKeywords() {
                const savedMedicine = localStorage.getItem('userMedicineKeywords');
                const savedNursing = localStorage.getItem('userNursingKeywords');

                userMedicineKeywords = savedMedicine ? JSON.parse(savedMedicine) : { ...MEDICINE_CATEGORY_KEYWORDS };
                userNursingKeywords = savedNursing ? JSON.parse(savedNursing) : { ...NURSING_CATEGORY_KEYWORDS };
            }

            function renderKeywordsEditor(career) {
                keywordsContent.innerHTML = '';
                const keywordData = career === 'Medicina' ? userMedicineKeywords : userNursingKeywords;
                
                const sortedCategories = Object.keys(keywordData).sort();

                sortedCategories.forEach(category => {
                    const keywords = keywordData[category];
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col';

                    const label = document.createElement('label');
                    label.className = 'font-semibold text-sm mb-1 text-gray-700';
                    label.textContent = category;

                    const textarea = document.createElement('textarea');
                    textarea.className = 'w-full h-24 p-2 border rounded-md text-xs font-mono focus:ring-blue-500 focus:border-blue-500';
                    textarea.value = keywords.join(', ');
                    textarea.dataset.category = category;
                    
                    wrapper.appendChild(label);
                    wrapper.appendChild(textarea);
                    keywordsContent.appendChild(wrapper);
                });
            }

            editKeywordsBtn.addEventListener('click', () => {
                keywordsModalContainer.classList.remove('hidden');
                renderKeywordsEditor('Medicina');
                keywordsTabs.querySelector('[data-career="Medicina"]').classList.add('active');
                keywordsTabs.querySelector('[data-career="Enfermeria"]').classList.remove('active');
            });
            
            keywordsTabs.addEventListener('click', (e) => {
                const target = e.target.closest('.keyword-tab-btn');
                if(!target) return;
                
                keywordsTabs.querySelectorAll('.keyword-tab-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                renderKeywordsEditor(target.dataset.career);
            });

            keywordsCancelBtn.addEventListener('click', () => keywordsModalContainer.classList.add('hidden'));
            
            keywordsSaveBtn.addEventListener('click', () => {
                const activeTab = keywordsTabs.querySelector('.active');
                const career = activeTab.dataset.career;
                const targetDict = career === 'Medicina' ? userMedicineKeywords : userNursingKeywords;

                keywordsContent.querySelectorAll('textarea').forEach(textarea => {
                    const category = textarea.dataset.category;
                    const keywords = textarea.value.split(',').map(kw => kw.trim()).filter(Boolean);
                    targetDict[category] = keywords;
                });
                
                const storageKey = career === 'Medicina' ? 'userMedicineKeywords' : 'userNursingKeywords';
                localStorage.setItem(storageKey, JSON.stringify(targetDict));
                
                alert(`Pistas para ${career} guardadas.`);
                keywordsModalContainer.classList.add('hidden');
            });

            keywordsRestoreBtn.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres restaurar las pistas por defecto para TODAS las carreras? Se perderán tus cambios.')) {
                    localStorage.removeItem('userMedicineKeywords');
                    localStorage.removeItem('userNursingKeywords');
                    loadKeywords();
                    alert('Pistas restauradas a los valores por defecto.');
                    const activeTab = keywordsTabs.querySelector('.active');
                    renderKeywordsEditor(activeTab.dataset.career);
                }
            });


            // --- Initial Render ---
            loadKeywords();
            loadState();
            renderHeader();
            applyFiltersAndSearch();
        });
    </script>
</body>
</html>

